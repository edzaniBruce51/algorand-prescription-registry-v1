{% block extra_scripts %}
<script>
/* ---------- Wizard logic ---------- */
(function(){
  const steps = Array.from(document.querySelectorAll('.step'));
  const progressBar = document.getElementById('progressBar');
  const stepTitle = document.getElementById('stepTitle');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');
  const form = document.getElementById('wizardForm');
  const reviewSummary = document.getElementById('reviewSummary');

  let current = 0;
  const titles = ['Patient Details','Prescription Details','Prescriber & Review'];

  function showStep(index){
    steps.forEach((s,i)=> s.classList.toggle('active', i===index));
    stepTitle.textContent = titles[index] || '';
    const pct = Math.round((index/(steps.length-1))*100);
    progressBar.style.width = pct + '%';
    prevBtn.style.display = index === 0 ? 'none' : 'inline-block';
    nextBtn.style.display = index === steps.length-1 ? 'none' : 'inline-block';
    submitBtn.style.display = index === steps.length-1 ? 'inline-block' : 'none';
    if(index === steps.length-1) populateReview();
  }

  function validateStep(index){
    const inputs = Array.from(steps[index].querySelectorAll('input, textarea'));
    for(const inp of inputs){
      if(inp.hasAttribute('required') && !inp.value.trim()){
        inp.focus();
        return {ok:false, field: inp};
      }
    }
    return {ok:true};
  }

  function getVal(name){ return (form.elements[name] ? form.elements[name].value.trim() : ''); }

  function populateReview(){
    reviewSummary.innerHTML = `
      <div><strong>Patient:</strong> ${getVal('patient_full_name')||'-'} (${getVal('patient_dob')||'-'})</div>
      <div style="margin-top:6px"><strong>Medication:</strong> ${getVal('medication_name')||'-'} — ${getVal('dosage_strength')||'-'}</div>
      <div style="margin-top:6px"><strong>Frequency:</strong> ${getVal('frequency_duration')||'-'} • <strong>Qty:</strong> ${getVal('quantity_to_dispense')||'-'}</div>
      <div style="margin-top:6px"><strong>Prescriber:</strong> ${getVal('prescriber_signature')||'-'}</div>
    `;
  }

  nextBtn.addEventListener('click', ()=>{
    const res = validateStep(current);
    if(!res.ok){
      const node = res.field;
      node.style.borderColor = '#ff6b6b';
      setTimeout(()=> node.style.borderColor = '', 1400);
      return;
    }
    current = Math.min(steps.length-1, current+1);
    showStep(current);
  });

  prevBtn.addEventListener('click', ()=>{
    current = Math.max(0, current-1);
    showStep(current);
  });

  form.addEventListener('submit', (e)=>{
    const finalValid = validateStep(current);
    if(!finalValid.ok){
      e.preventDefault();
      const node = finalValid.field;
      node.style.borderColor = '#ff6b6b';
      node.focus();
      setTimeout(()=> node.style.borderColor = '', 1400);
    }else{
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
    }
  });

  showStep(current);
})();

/* ---------- Payload hash (client-side canonical SHA-256) ---------- */
(async function computePayloadHashes(){
  const enc = new TextEncoder();
  function canonicalize(obj){
    const keys = Object.keys(obj).sort();
    const out = {};
    for(const k of keys){ out[k] = obj[k]; }
    return JSON.stringify(out);
  }
  async function sha256Hex(str){
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
    const bytes = new Uint8Array(buf);
    return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  const cards = document.querySelectorAll('.prescription-card');
  for(const card of cards){
    const payloadTag = card.querySelector('script.payload-json');
    const hashEl = card.querySelector('.payload-hash');
    if(payloadTag && hashEl){
      try{
        const obj = JSON.parse(payloadTag.textContent || '{}');
        const canon = canonicalize(obj);
        const hash = await sha256Hex(canon);
        hashEl.textContent = hash;
      }catch(e){
        hashEl.textContent = 'n/a';
      }
    }
  }
})();

/* ---------- Live updates (minimal fallback only) ----------
   Just reloads the page every 10 seconds to catch webhook updates.
------------------------------------------------------------- */
setInterval(() => location.reload(), 10000);
</script>
{% endblock %}
