{% extends "base.html" %}

{% block content %}
<style>
  .form-card{ background:#f8faf9; border-radius:10px; padding:18px; border:1px solid rgba(6,95,70,0.04); }
  .step { display:none; }
  .step.active { display:block; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
  @media (max-width:720px){ .row{ grid-template-columns:1fr } }
  .controls{ display:flex; gap:10px; margin-top:10px; align-items:center; }
  .empty-state{ padding:10px; border-radius:8px; background:#fff; border:1px solid rgba(6,95,70,0.04) }
  .prescription-url{ color: var(--accent); text-decoration:none }
  .prescription-url:hover{ text-decoration:underline }
  pre.json-view { font-size:.8rem; background:#f4f8f7; padding:8px; border-radius:6px; overflow:auto; max-height:200px; }
  .badge { padding:2px 6px; border-radius:4px; background:#0f766e; color:#fff; font-size:.75rem; }
  .btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#0f766e; color:#fff; font-weight:600; text-decoration:none; display:inline-block; }
  .btn.secondary { background:#065f46; }
  .prescription-card { background:#fff; border:1px solid rgba(6,95,70,0.08); border-radius:10px; padding:12px; margin-bottom:12px; }
  .title { font-weight:700; margin-bottom:6px; }
  .meta { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; font-size:.75rem; color:#555; }
  .patient-details { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  @media (max-width:720px){ .patient-details{ grid-template-columns:1fr } }
</style>

<div class="card" aria-live="polite">
  <div class="progress" aria-hidden="true"><div class="progress-bar" id="progressBar"></div></div>
  <div class="step-title" id="stepTitle" style="font-weight:700; margin:6px 0 12px; color:#06303a">Patient Details</div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash flash-{{ category }}" role="status" style="margin-bottom:10px;">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form id="wizardForm" action="/register_prescription" method="post" novalidate>
    <!-- Step 1 -->
    <div class="step active" data-step="1" id="step1">
      <div class="row">
        <div>
          <label for="patient_full_name">Patient's Full Name</label>
          <input id="patient_full_name" name="patient_full_name" type="text" placeholder="e.g., Alice Demo" required>
        </div>
        <div>
          <label for="patient_dob">Patient DOB</label>
          <input id="patient_dob" name="patient_dob" type="date" placeholder="YYYY-MM-DD" required>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="prescription_date">Date of Prescription</label>
          <input id="prescription_date" name="prescription_date" type="date" placeholder="YYYY-MM-DD" required>
        </div>
        <div>
          <label for="medication_name">Medication Name</label>
          <input id="medication_name" name="medication_name" type="text" placeholder="e.g., Amoxicillin" required>
        </div>
      </div>
      <div class="small">Tip: press <strong>Next</strong> to continue ‚Äî fields are saved until submission.</div>
    </div>

    <!-- Step 2 -->
    <div class="step" data-step="2" id="step2">
      <div class="row">
        <div>
          <label for="dosage_strength">Dosage & Strength</label>
          <input id="dosage_strength" name="dosage_strength" type="text" placeholder="e.g., 500 mg" required>
        </div>
        <div>
          <label for="route_of_administration">Route of Administration</label>
          <input id="route_of_administration" name="route_of_administration" type="text" placeholder="e.g., oral" required>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="frequency_duration">Frequency & Duration</label>
          <input id="frequency_duration" name="frequency_duration" type="text" placeholder="e.g., 2x/day for 7 days" required>
        </div>
        <div>
          <label for="quantity_to_dispense">Quantity to Dispense</label>
          <input id="quantity_to_dispense" name="quantity_to_dispense" type="text" placeholder="e.g., 14" required>
        </div>
      </div>
      <div style="margin-bottom:8px;">
        <label for="refill_info">Refill Information</label>
        <input id="refill_info" name="refill_info" type="text" placeholder="e.g., 1 refill allowed">
      </div>
    </div>

    <!-- Step 3 -->
    <div class="step" data-step="3" id="step3">
      <div style="margin-bottom:12px;">
        <label for="prescriber_signature">Prescriber's Signature & Credentials</label>
        <input id="prescriber_signature" name="prescriber_signature" type="text" placeholder="e.g., Dr John Doe - Reg 12345" required>
      </div>
      <div style="margin-top:10px;">
        <strong>Review before submitting:</strong>
        <div class="small" style="margin-top:8px;">Use the submit button below to register the prescription ‚Äî it will be sent to the BaaS provider and queued for blockchain anchoring.</div>
        <div id="reviewSummary" style="margin-top:12px;padding:12px;border-radius:8px;background:#fff;border:1px solid rgba(6,95,70,0.03);"></div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button type="button" class="btn secondary" id="prevBtn" style="display:none">‚Üê Back</button>
      <div style="flex:1"></div>
      <button type="button" class="btn" id="nextBtn">Next ‚Üí</button>
      <button type="submit" class="btn" id="submitBtn" style="display:none">Submit</button>
    </div>
  </form>
</div>
{% endblock %}

{% block right_column %}
<div id="prescriptions-container">
  <h2>Registered Prescriptions ({{ prescriptions|length }})</h2>

  {% if prescriptions %}
    {% for prescription in prescriptions %}
      <div class="prescription-card" role="article" aria-label="Prescription {{ prescription.data_id }}" data-id="{{ prescription.data_id }}">
        <div class="title">{{ prescription.patient_full_name }}</div>

        <div class="patient-details">
          <p class="small"><strong>DOB:</strong> {{ prescription.patient_dob or '-' }}</p>
          <p class="small"><strong>Medication:</strong> {{ prescription.medication_name or '-' }}</p>
          <p class="small"><strong>Date:</strong> {{ prescription.prescription_date or '-' }}</p>
          <p class="small"><strong>Dosage:</strong> {{ prescription.dosage_strength or '-' }}</p>
          <p class="small"><strong>Route:</strong> {{ prescription.route_of_administration or '-' }}</p>
          <p class="small"><strong>Frequency:</strong> {{ prescription.frequency_duration or '-' }}</p>
          <p class="small"><strong>Quantity:</strong> {{ prescription.quantity_to_dispense or '-' }}</p>
          <p class="small"><strong>Refill:</strong> {{ prescription.refill_info or '-' }}</p>
          <p class="small"><strong>Prescriber:</strong> {{ prescription.prescriber_signature or '-' }}</p>
        </div>

        <div class="meta">
          {% if prescription.status %}<span class="badge">{{ prescription.status|capitalize }}</span>{% endif %}
          {% if prescription.data_id %}<span class="small">ID: {{ prescription.data_id }}</span>{% endif %}
          {% if prescription.baas_task_id %}<span class="small">Task: {{ prescription.baas_task_id }}</span>{% endif %}
          {% if prescription.blockchain_tx_id %}
            <a class="btn verify" href="/verify_prescription?tx_id={{ prescription.blockchain_tx_id }}" >üîç Verify</a>
          {% endif %}
        </div>

        <div class="small mt-8">
          <strong>Payload Hash (SHA-256):</strong>
          <code class="payload-hash">{{ prescription.jsonPayloadHash or 'computing‚Ä¶' }}</code>
        </div>

        <div style="margin-top:8px;"><strong>Prescription Payload:</strong></div>
        <pre class="json-view payload-json">
{{ prescription.jsonPayload 
   | default('{}') 
   | tojson(indent=2) 
}}
        </pre>
      </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <h3>No Prescriptions yet</h3>
      <p>Register a demo prescription to see blockchain anchoring.</p>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
/* ---------- Wizard logic ---------- */
(function(){
  const steps = Array.from(document.querySelectorAll('.step'));
  const progressBar = document.getElementById('progressBar');
  const stepTitle = document.getElementById('stepTitle');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');
  const form = document.getElementById('wizardForm');
  const reviewSummary = document.getElementById('reviewSummary');

  let current = 0;
  const titles = ['Patient Details','Prescription Details','Prescriber & Review'];

  function showStep(index){
    steps.forEach((s,i)=> s.classList.toggle('active', i===index));
    stepTitle.textContent = titles[index] || '';
    const pct = Math.round((index/(steps.length-1))*100);
    progressBar.style.width = pct + '%';
    prevBtn.style.display = index === 0 ? 'none' : 'inline-block';
    nextBtn.style.display = index === steps.length-1 ? 'none' : 'inline-block';
    submitBtn.style.display = index === steps.length-1 ? 'inline-block' : 'none';
    if(index === steps.length-1) populateReview();
  }

  function populateReview(){
    const data = {};
    form.querySelectorAll('input').forEach(input=>{
      data[input.name] = input.value;
    });
    reviewSummary.textContent = JSON.stringify(data, null, 2);
  }

  nextBtn.addEventListener('click', ()=>{ current++; showStep(current); });
  prevBtn.addEventListener('click', ()=>{ current--; showStep(current); });
  showStep(current);
})();

/* ---------- Live prescription status & hash update ---------- */
async function updatePrescriptions() {
  try {
    const res = await fetch('/prescriptions_json');
    const data = await res.json();

    for(const prescription of data){
      const card = document.querySelector(`.prescription-card[data-id="${prescription.data_id}"]`);
      if(!card) continue;

      // Update status
      const badge = card.querySelector('.badge');
      if(badge) badge.textContent = prescription.status || 'pending';

      // Update verify button
      let verifyBtn = card.querySelector('.btn.verify');
      if(prescription.blockchain_tx_id){
        if(!verifyBtn){
          verifyBtn = document.createElement('a');
          verifyBtn.className = 'btn verify';
          verifyBtn.textContent = 'üîç Verify';
          verifyBtn.target = '_blank';
          card.querySelector('.meta').appendChild(verifyBtn);
        }
        verifyBtn.href = `/verify_prescription?tx_id=${prescription.blockchain_tx_id}`;
      }

      // Update payload hash
      const hashElem = card.querySelector('.payload-hash');
      if(hashElem) hashElem.textContent = prescription.jsonPayloadHash || 'computing‚Ä¶';

      // Update full JSON payload
      const jsonElem = card.querySelector('.json-view');
      if(jsonElem) {
        if (prescription.jsonPayload) {
            let payloadObj = typeof prescription.jsonPayload === 'string' 
                            ? JSON.parse(prescription.jsonPayload) 
                            : prescription.jsonPayload;
            jsonElem.textContent = JSON.stringify(payloadObj, null, 2);
        } else {
            jsonElem.textContent = '{}';
        }
      }
    }
  } catch(err) {
    console.error('Error fetching prescriptions:', err);
  }
}

// Poll every 5 seconds
setInterval(updatePrescriptions, 5000);
updatePrescriptions();
</script>
{% endblock %}
