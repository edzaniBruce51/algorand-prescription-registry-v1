{% extends "base.html" %}

{% block content %}
  <!-- page-specific tiny styles for the wizard -->
  <style>
    .form-card{ background:#f8faf9; border-radius:10px; padding:18px; border:1px solid rgba(6,95,70,0.04); }
    .step { display:none; }
    .step.active { display:block; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
    @media (max-width:720px){ .row{ grid-template-columns:1fr } }
    .controls{ display:flex; gap:10px; margin-top:10px; align-items:center; }
    .empty-state{ padding:10px; border-radius:8px; background:#fff; border:1px solid rgba(6,95,70,0.04) }
    .prescription-url{ color: var(--accent); text-decoration:none }
    .prescription-url:hover{ text-decoration:underline }
    pre.json-view { font-size:.8rem; background:#f4f8f7; padding:8px; border-radius:6px; overflow:auto; }
  </style>

  <!-- LEFT: Wizard form (uses base.css tokens) -->
  <div class="card" aria-live="polite">
    <!-- Progress -->
    <div class="progress" aria-hidden="true"><div class="progress-bar" id="progressBar"></div></div>

    <!-- Step title -->
    <div class="step-title" id="stepTitle" style="font-weight:700; margin:6px 0 12px; color:#06303a">Patient Details</div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}" role="status" style="margin-bottom:10px;">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Multi-step form -->
    <form id="wizardForm" action="/register_prescription" method="post" novalidate>
      <!-- Step 1: Patient -->
      <div class="step active" data-step="1" id="step1">
        <div class="row">
          <div>
            <label for="patient_full_name">Patient's Full Name</label>
            <input id="patient_full_name" name="patient_full_name" type="text" placeholder="e.g., Alice Demo" required>
          </div>
          <div>
            <label for="patient_dob">Patient DOB</label>
            <input id="patient_dob" name="patient_dob" type="text" placeholder="YYYY-MM-DD" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="prescription_date">Date of Prescription</label>
            <input id="prescription_date" name="prescription_date" type="text" placeholder="YYYY-MM-DD" required>
          </div>
          <div>
            <label for="medication_name">Medication Name</label>
            <input id="medication_name" name="medication_name" type="text" placeholder="e.g., Amoxicillin" required>
          </div>
        </div>

        <div class="small">Tip: press <strong>Next</strong> to continue ‚Äî fields are saved until submission.</div>
      </div>

      <!-- Step 2: Prescription Details -->
      <div class="step" data-step="2" id="step2">
        <div class="row">
          <div>
            <label for="dosage_strength">Dosage & Strength</label>
            <input id="dosage_strength" name="dosage_strength" type="text" placeholder="e.g., 500 mg" required>
          </div>
          <div>
            <label for="route_of_administration">Route of Administration</label>
            <input id="route_of_administration" name="route_of_administration" type="text" placeholder="e.g., oral" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="frequency_duration">Frequency & Duration</label>
            <input id="frequency_duration" name="frequency_duration" type="text" placeholder="e.g., 2x/day for 7 days" required>
          </div>
          <div>
            <label for="quantity_to_dispense">Quantity to Dispense</label>
            <input id="quantity_to_dispense" name="quantity_to_dispense" type="text" placeholder="e.g., 14" required>
          </div>
        </div>

        <div style="margin-bottom:8px;">
          <label for="refill_info">Refill Information</label>
          <input id="refill_info" name="refill_info" type="text" placeholder="e.g., 1 refill allowed">
        </div>
      </div>

      <!-- Step 3: Prescriber & Review -->
      <div class="step" data-step="3" id="step3">
        <div style="margin-bottom:12px;">
          <label for="prescriber_signature">Prescriber's Signature & Credentials</label>
          <input id="prescriber_signature" name="prescriber_signature" type="text" placeholder="e.g., Dr John Doe - Reg 12345" required>
        </div>

        <div style="margin-top:10px;">
          <strong>Review before submitting:</strong>
          <div class="small" style="margin-top:8px;">Use the submit button below to register the prescription ‚Äî it will be sent to the BaaS provider and queued for blockchain anchoring.</div>

          <!-- Small inline summary (JS will populate) -->
          <div id="reviewSummary" style="margin-top:12px;padding:12px;border-radius:8px;background:#fff;border:1px solid rgba(6,95,70,0.03);"></div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button type="button" class="btn secondary" id="prevBtn" style="display:none">‚Üê Back</button>
        <div style="flex:1"></div>
        <button type="button" class="btn" id="nextBtn">Next ‚Üí</button>
        <button type="submit" class="btn" id="submitBtn" style="display:none">Submit</button>
      </div>
    </form>
  </div>
{% endblock %}

{% block right_column %}
  <!-- RIGHT: Registered prescriptions -->
  <div class="list-card">
    <h2>Registered Prescriptions ({{ prescriptions|length }})</h2>

    {% if prescriptions %}
      {% for prescription in prescriptions|reverse %}
        <div class="prescription-card" role="article" aria-label="Prescription {{ prescription.data_id }}">
          <div class="title">{{ prescription.patient_full_name }}</div>

          <!-- All attributes -->
          <p class="small"><strong>DOB:</strong> {{ prescription.patient_dob or '-' }}</p>
          <p class="small"><strong>Medication:</strong> {{ prescription.medication_name or '-' }}</p>
          <p class="small"><strong>Date:</strong> {{ prescription.prescription_date or '-' }}</p>
          <p class="small"><strong>Dosage:</strong> {{ prescription.dosage_strength or '-' }}</p>
          <p class="small"><strong>Route:</strong> {{ prescription.route_of_administration or '-' }}</p>
          <p class="small"><strong>Frequency:</strong> {{ prescription.frequency_duration or '-' }}</p>
          <p class="small"><strong>Quantity:</strong> {{ prescription.quantity_to_dispense or '-' }}</p>
          <p class="small"><strong>Refill:</strong> {{ prescription.refill_info or '-' }}</p>
          <p class="small"><strong>Prescriber:</strong> {{ prescription.prescriber_signature or '-' }}</p>

          <!-- Meta -->
          <div class="meta">
            {% if prescription.status %}
              <span class="badge {{ prescription.status }}">{{ prescription.status|capitalize }}</span>
            {% endif %}
            {% if prescription.data_id %}<span class="small">ID: {{ prescription.data_id }}</span>{% endif %}
            {% if prescription.baas_task_id %}<span class="small">Task: {{ prescription.baas_task_id }}</span>{% endif %}
            {% if prescription.blockchain_tx_id %}
              <span class="small">
                <strong>Blockchain Tx:</strong>
                <a class="prescription-url" target="_blank"
                   href="https://testnet.explorer.perawallet.app/tx/{{ prescription.blockchain_tx_id }}">{{ prescription.blockchain_tx_id }}</a>
                <a class="nav-btn" href="/verify_prescription?tx_id={{ prescription.blockchain_tx_id }}">üîç Verify</a>
              </span>
            {% endif %}
          </div>

          <!-- Payload hash + JSON -->
          <div class="small mt-8">
            <strong>Payload Hash (SHA-256):</strong>
            <code class="payload-hash">computing‚Ä¶</code>
          </div>

          <!-- Canonical JSON for hashing (machine-readable) -->
          <script type="application/json" class="payload-json">
            {{ {
              "application": "prescriptionRegistry",
              "version": 1,
              "patient_full_name": prescription.patient_full_name,
              "patient_dob": prescription.patient_dob,
              "prescription_date": prescription.prescription_date,
              "medication_name": prescription.medication_name,
              "dosage_strength": prescription.dosage_strength,
              "route_of_administration": prescription.route_of_administration,
              "frequency_duration": prescription.frequency_duration,
              "quantity_to_dispense": prescription.quantity_to_dispense,
              "refill_info": prescription.refill_info,
              "prescriber_signature": prescription.prescriber_signature
            } | tojson }}
          </script>

          <details style="margin-top:8px">
            <summary class="small">üìÑ Full JSON Payload</summary>
            <pre class="json-view">{{ prescription | tojson(indent=2) }}</pre>
          </details>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <h3 style="margin-bottom:8px">No Prescriptions yet</h3>
        <p class="small">Register a demo prescription to see the round-trip with the BaaS provider (testnet).</p>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
/* ---------- Wizard logic ---------- */
(function(){
  const steps = Array.from(document.querySelectorAll('.step'));
  const progressBar = document.getElementById('progressBar');
  const stepTitle = document.getElementById('stepTitle');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');
  const form = document.getElementById('wizardForm');
  const reviewSummary = document.getElementById('reviewSummary');

  let current = 0;
  const titles = ['Patient Details','Prescription Details','Prescriber & Review'];

  function showStep(index){
    steps.forEach((s,i)=> s.classList.toggle('active', i===index));
    stepTitle.textContent = titles[index] || '';
    const pct = Math.round((index/(steps.length-1))*100);
    progressBar.style.width = pct + '%';
    prevBtn.style.display = index === 0 ? 'none' : 'inline-block';
    nextBtn.style.display = index === steps.length-1 ? 'none' : 'inline-block';
    submitBtn.style.display = index === steps.length-1 ? 'inline-block' : 'none';
    if(index === steps.length-1) populateReview();
  }

  function validateStep(index){
    const inputs = Array.from(steps[index].querySelectorAll('input, textarea'));
    for(const inp of inputs){
      if(inp.hasAttribute('required') && !inp.value.trim()){
        inp.focus();
        return {ok:false, field: inp};
      }
    }
    return {ok:true};
  }

  function getVal(name){ return (form.elements[name] ? form.elements[name].value.trim() : ''); }

  function populateReview(){
    reviewSummary.innerHTML = `
      <div><strong>Patient:</strong> ${getVal('patient_full_name')||'-'} (${getVal('patient_dob')||'-'})</div>
      <div style="margin-top:6px"><strong>Medication:</strong> ${getVal('medication_name')||'-'} ‚Äî ${getVal('dosage_strength')||'-'}</div>
      <div style="margin-top:6px"><strong>Frequency:</strong> ${getVal('frequency_duration')||'-'} ‚Ä¢ <strong>Qty:</strong> ${getVal('quantity_to_dispense')||'-'}</div>
      <div style="margin-top:6px"><strong>Prescriber:</strong> ${getVal('prescriber_signature')||'-'}</div>
    `;
  }

  nextBtn.addEventListener('click', ()=>{
    const res = validateStep(current);
    if(!res.ok){
      const node = res.field;
      node.style.borderColor = '#ff6b6b';
      setTimeout(()=> node.style.borderColor = '', 1400);
      return;
    }
    current = Math.min(steps.length-1, current+1);
    showStep(current);
  });

  prevBtn.addEventListener('click', ()=>{
    current = Math.max(0, current-1);
    showStep(current);
  });

  form.addEventListener('submit', (e)=>{
    const finalValid = validateStep(current);
    if(!finalValid.ok){
      e.preventDefault();
      const node = finalValid.field;
      node.style.borderColor = '#ff6b6b';
      node.focus();
      setTimeout(()=> node.style.borderColor = '', 1400);
    }else{
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
    }
  });

  showStep(current);
})();

/* ---------- Payload hash (client-side canonical SHA-256) ---------- */
(async function computePayloadHashes(){
  const enc = new TextEncoder();
  function canonicalize(obj){
    // stable key order
    const keys = Object.keys(obj).sort();
    const out = {};
    for(const k of keys){ out[k] = obj[k]; }
    return JSON.stringify(out); // compact form
  }
  async function sha256Hex(str){
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
    const bytes = new Uint8Array(buf);
    return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  const cards = document.querySelectorAll('.prescription-card');
  for(const card of cards){
    const payloadTag = card.querySelector('script.payload-json');
    const hashEl = card.querySelector('.payload-hash');
    if(payloadTag && hashEl){
      try{
        const obj = JSON.parse(payloadTag.textContent || '{}');
        const canon = canonicalize(obj);
        const hash = await sha256Hex(canon);
        hashEl.textContent = hash;
      }catch(e){
        hashEl.textContent = 'n/a';
      }
    }
  }
})();

/* ---------- Live updates (minimal fallback only) ----------
   Just reloads the page every 10 seconds to catch webhook updates.
------------------------------------------------------------- */

setInterval(() => location.reload(), 10000);
</script>

{% endblock %}
