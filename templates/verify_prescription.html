{% extends "base.html" %}
{% block title %}Verify Prescription — Prescription Registry{% endblock %}

{% block content %}
  <section>
    <div class="card">
      <!-- Flash -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash flash-{{ category }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Enhanced Success/Error Message Display for POST results -->
      {% if mode == "post" and verification_message %}
        <div class="verification-result-banner verification-{{ verification_status }}">
          {{ verification_message }}
        </div>
      {% endif %}

      <form action="/verify_prescription" method="post" class="mt-8" id="verificationForm">
        <div style="margin-bottom:15px">
          <label for="transactionId">Transaction ID (Required)</label>
          <input id="transactionId" name="transactionId" type="text" value="{{ tx_id or '' }}" required>
        </div>

        <!-- Verification Method Selection -->
        <div style="margin-bottom:20px; padding:15px; background:#f8f9fa; border-radius:8px; border: 1px solid #dee2e6;">
          <label style="font-weight:bold; margin-bottom:15px; display:block; color:#495057;">Choose Verification Method:</label>
          
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" name="verification_type" value="payload" id="payloadRadio" {% if verification_type == "payload" or not verification_type %}checked{% endif %}>
              <label for="payloadRadio">
                <span class="radio-title">Verify using JSON Payload</span>
                <span class="radio-description">Compare actual data</span>
              </label>
            </div>
            
            <div class="radio-option">
              <input type="radio" name="verification_type" value="hash" id="hashRadio" {% if verification_type == "hash" %}checked{% endif %}>
              <label for="hashRadio">
                <span class="radio-title">Verify using Hash</span>
                <span class="radio-description">Compare data fingerprint</span>
              </label>
            </div>
          </div>
        </div>

        <div style="margin-bottom:15px" id="payloadSection">
          <label for="jsonPayload">JSON Payload</label>
          <textarea id="jsonPayload" name="jsonPayload" placeholder='{"application":"prescriptionRegistry", "patient_full_name":"Alice Demo", ...}' rows="6"></textarea>
          <small style="color:#6c757d; display:block; margin-top:5px;">
            Paste the complete JSON data to verify it matches what's stored on the blockchain
          </small>
        </div>

        <div style="margin-bottom:15px" id="hashSection">
          <label for="jsonPayloadHash">JSON Payload Hash - Base64</label>
          <input id="jsonPayloadHash" name="jsonPayloadHash" type="text" placeholder="Base64 SHA-256 hash">
          <small style="color:#6c757d; display:block; margin-top:5px;">
            Enter the Base64 SHA-256 hash to verify the data fingerprint
          </small>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <a href="/" class="btn">← Back</a>
          <button type="submit" class="btn">Verify Prescription</button>
        </div>
      </form>

      {% if result %}
        <div class="list-card mt-8" style="margin-top:20px;">
          <h3>Verification Result</h3>
          <pre style="background:#f7fdfc;padding:15px;border-radius:8px;overflow:auto; border:1px solid #e9ecef;">{{ result | tojson(indent=2) }}</pre>
        </div>
      {% endif %}
    </div>
  </section>

  <style>
    .verification-result-banner {
      padding: 15px;
      margin: 10px 0 20px 0;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      border: 2px solid;
    }
    
    .verification-success {
      background-color: #d4edda;
      color: #155724;
      border-color: #28a745;
    }
    
    .verification-error {
      background-color: #f8d7da;
      color: #721c24;
      border-color: #dc3545;
    }
    
    .form-section-disabled {
      opacity: 0.4;
      pointer-events: none;
    }
    
    /* Clean radio button styling */
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .radio-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .radio-option:hover {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    
    .radio-option input[type="radio"] {
      margin: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #007bff;
    }
    
    .radio-option input[type="radio"]:checked + label .radio-title {
      color: #007bff;
      font-weight: 600;
    }
    
    .radio-option:has(input:checked) {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    
    .radio-option label {
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      margin: 0;
    }
    
    .radio-title {
      font-weight: 500;
      color: #495057;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .radio-description {
      font-size: 12px;
      color: #6c757d;
    }
    
    textarea, input[type="text"] {
      transition: all 0.2s ease;
    }
    
    .disabled-input {
      background-color: #f8f9fa !important;
      color: #6c757d !important;
      cursor: not-allowed !important;
    }

    /* Remove any unwanted highlighting */
    input[type="radio"]:focus {
      outline: 2px solid #007bff;
      outline-offset: 2px;
    }

    /* Remove yellow highlighting if present */
    input[type="radio"]:focus-visible {
      outline: 2px solid #007bff;
      outline-offset: 2px;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const payloadRadio = document.getElementById('payloadRadio');
      const hashRadio = document.getElementById('hashRadio');
      const payloadSection = document.getElementById('payloadSection');
      const hashSection = document.getElementById('hashSection');
      const jsonPayload = document.getElementById('jsonPayload');
      const jsonPayloadHash = document.getElementById('jsonPayloadHash');
      
      function updateFormState() {
        if (payloadRadio.checked) {
          // Enable payload section, disable hash section
          payloadSection.classList.remove('form-section-disabled');
          hashSection.classList.add('form-section-disabled');
          
          jsonPayload.disabled = false;
          jsonPayload.classList.remove('disabled-input');
          
          jsonPayloadHash.disabled = true;
          jsonPayloadHash.classList.add('disabled-input');
          jsonPayloadHash.value = '';  // Clear hash when switching to payload
          
        } else if (hashRadio.checked) {
          // Enable hash section, disable payload section
          hashSection.classList.remove('form-section-disabled');
          payloadSection.classList.add('form-section-disabled');
          
          jsonPayloadHash.disabled = false;
          jsonPayloadHash.classList.remove('disabled-input');
          
          jsonPayload.disabled = true;
          jsonPayload.classList.add('disabled-input');
          jsonPayload.value = '';  // Clear payload when switching to hash
        }
      }
      
      // Set initial state
      if (!payloadRadio.checked && !hashRadio.checked) {
        // Default to payload if nothing is selected
        // If neither radio is chosen, it defaults to payload mode and updates the form.
        payloadRadio.checked = true;
      }
      updateFormState();
      
      // Add event listeners
      // Listen for changes
      payloadRadio.addEventListener('change', updateFormState);
      hashRadio.addEventListener('change', updateFormState);
      
      // Form validation
      // check if verification type is selected
      // if payload → JSON must not be empty
      // if hash → hash input must not be empty
      document.getElementById('verificationForm').addEventListener('submit', function(e) {
        const verificationType = document.querySelector('input[name="verification_type"]:checked');
        
        if (!verificationType) {
          e.preventDefault();
          alert('Please select a verification method.');
          return false;
        }
        
        if (verificationType.value === 'payload' && !jsonPayload.value.trim()) {
          e.preventDefault();
          alert('Please provide the JSON payload for verification.');
          return false;
        }
        
        if (verificationType.value === 'hash' && !jsonPayloadHash.value.trim()) {
          e.preventDefault();
          alert('Please provide the hash for verification.');
          return false;
        }
        
        return true;
      });
    });
  </script>
{% endblock %}

{% block right_column %}{% endblock %}

{% block extra_scripts %}{% endblock %}