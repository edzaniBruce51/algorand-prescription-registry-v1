{% extends "base.html" %}
{% block title %}Verify Prescription — Prescription Registry{% endblock %}

{% block content %}
  <section>
    <div class="card">
      <!-- Flash -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash flash-{{ category }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form action="/verify_prescription" method="post" class="mt-8">
        <div style="margin-bottom:10px">
          <label for="transactionId">Transaction ID (Required)</label>
          <input id="transactionId" name="transactionId" type="text" value="{{ tx_id or '' }}" required>
        </div>

        <!-- Verification Mode -->
        <div style="margin-bottom:14px">
          <label><input type="radio" name="verifyMode" value="payload" checked> Verify using JSON Payload</label>
          <label style="margin-left:15px;"><input type="radio" name="verifyMode" value="hash"> Verify using Hash</label>
        </div>

        <!-- JSON Payload -->
        <div style="margin-bottom:10px">
          <label for="jsonPayload">JSON Payload</label>
          <textarea id="jsonPayload" name="jsonPayload" placeholder='{"application":"prescriptionRegistry", "patient_full_name":"Alice Demo", ...}'></textarea>
        </div>

        <!-- JSON Payload Hash -->
        <div style="margin-bottom:10px">
          <label for="jsonPayloadHash">JSON Payload Hash - Base64</label>
          <input id="jsonPayloadHash" name="jsonPayloadHash" type="text" placeholder="Base64 SHA-256 hash" disabled>
        </div>

        <div style="display:flex; gap:10px; align-items:center">
          <a href="/" class="btn">← Back</a>
          <button type="submit" class="btn">Verify Prescription</button>
        </div>
      </form>

      {% if result %}
        <div class="flash {% if result.data.isJsonPayloadHashVerified %}flash-success{% else %}flash-error{% endif %}" style="margin-top:14px;">
          {% if mode == 'hash' %}
            {% if result.data.isJsonPayloadHashVerified %}
              Prescription verification successful. Provided data hash (fingerprint) matches on-chain hash.
            {% else %}
              Prescription verification unsuccessful. Provided data hash (fingerprint) does not match on-chain hash.
            {% endif %}
          {% else %}
            {% if result.data.isJsonPayloadHashVerified %}
              Prescription verification successful. Provided data payload matches original data payload.
            {% else %}
              Prescription verification unsuccessful. Provided data payload does not match original data payload.
            {% endif %}
          {% endif %}
        </div>

        <div class="list-card mt-8">
          <h3>Verification Result</h3>
          <pre style="background:#f7fdfc;padding:12px;border-radius:8px;overflow:auto">{{ result | tojson(indent=2) }}</pre>
        </div>
      {% endif %}
    </div>
  </section>
{% endblock %}

{% block right_column %}{% endblock %}

{% block extra_scripts %}
<script>
  const modeRadios = document.querySelectorAll("input[name='verifyMode']");
  const payloadInput = document.getElementById("jsonPayload");
  const hashInput = document.getElementById("jsonPayloadHash");

  function toggleInputs() {
    const selected = document.querySelector("input[name='verifyMode']:checked").value;
    if (selected === "hash") {
      hashInput.disabled = false;
      payloadInput.disabled = true;
    } else {
      hashInput.disabled = true;
      payloadInput.disabled = false;
    }
  }

  modeRadios.forEach(radio => radio.addEventListener("change", toggleInputs));
  toggleInputs(); // run once on load
</script>
{% endblock %}
